<html>
<head>
    <title>SGUI - Hacking SGUI</title>
    <link rel="stylesheet" type="text/css" href="style.css">
</head>
<body>

<h1>SGUI</h1>

<h2>Hacking SGUI</h2>

This chapter is intended to provide an overview and details of the
architecture and internal workings of SGUI for people who intend to make
changes or additions to SGUI.

<h3 id="arch">Architectural overview</h3>

The SGUI library is split into a <b>core</b> module (the directory 'core' in
the source tree) and the <b>widget</b> code (the directory 'widgets').<br>
<br>
The core module contains all basic data structures and the platform dependend
implementations. It consits basically of the following subsystems:
<ul>
<li>The <b>initialization and mainloop</b> functions are declared inside
    <b>sgui.h</b>. They are directly implemented in the backend.
<li>The <b>event management</b> subsystem takes care of an even queue
    and the event-action-connections. The declarations are in
    <b>sgui_event.h</b> and the implementation in <b>event.c</b> in the source
    directory. The keyboard codes are defined in <b>sgui_keycodes.h</b>.
<li><b>Helper data structures</b>: There is a data structure for handling
    rectangles. Declarations are in <b>sgui_rect.h</b> and implementation in
    <b>rect.c</b>. There are UTF8 string handling functions declared in
    <b>sgui_utf8.h</b> and implemented in <b>utf8.c</b>.
<li><b>Filesystem abstraction</b> is provided by <b>sgui_filesystem.h</b>
    with a reference implementation in <b>filesystem.c</b>.
<li><b>Window abstraction</b> is proved in <b>sgui_window.h</b>, declaring
    window functions. <b>sgui_window_create_desc</b> is the only function
    directly implemented by the backend. All other functions are implemented
    in <b>window.c</b> and do sanity checking before using backend callbacks
    from the <b>sgui_window</b> abstract base structure, declared in
    <b>sgui_internal.h</b>.
<li>An abstract <b>OpenGL&reg;</b> context data type is declared in
    <b>sgui_internal.h</b> with inteface functions in <b>sgui_opengl.h</b>.
    The interface functions are implemented directly in the backend.
<li>Interface functions for <b>an abstract widget data type</b> are declared
    in <b>sgui_widget.h</b> and implemented in <b>widget.c</b>. The
    declaration of the <b>sgui_widget</b> data structure is in
    <b>sgui_internal.h</b>. The functions provide managing of widget
    child-parent trees and propagation of widget states and events. The widget
    data structure has several callbacks for widget implementations (events,
    state change, rendering).
<li><b>Rendering</b> is done by the <b>sgui_canvas</b> data structure, also
    declared in <b>sgui_internal.h</b>. The <b>sgui_canvas.h</b> header
    delcares the interface functions, implemented in <b>canvas.c</b>. Each
    window has a canvas that widgets can be attached to. The backend code can
    implement its own canvas type, or alternatively use the referenc
    implementation in <b>mem_canvas.c</b> that renders to an offscreen memory
    buffer. A canvas can also create pixmaps. Pixmap interface functions are
    declared in <b>sgui_pixmap.h</b> and implemented in <b>pixmap.c</b>. The
    underlying abstract data type is declared in <b>sgui_internal.h</b> with
    callbacks for canvas implementation dependend functions. The reference
    implementation for the memory canvas is in <b>mem_pixmap.c</b>
<li><b>Font rendering abstraction</b> is handled by the <b>sgui_font</b>
    structure, declared in <b>sgui_font.h</b>. There are no interface
    functions, the implementation is directly in the backend. All the
    implementation does is to provide font loading and glyph
    rasterization. There is no reference implementation.
<li><b>Glyph caching</b> is provided by the <b>sgui_font_cache</b> data
    structure. The interface functions are in <b>sgui_font_cache.h</b> and
    implemented in <b>font_cache.c</b>. A backend may or may not use this
    data structure to cache glyphs. The implementation uses an RB-Tree of
    rects to pre-rendered and organize glyphs on a pixmap.
<li>Actually rendering a widget onto a canvas is done by the <b>skinning</b>
    subsystem. The file <b>sgui_skin.h</b> contains a list of functions that
    can be used to draw widgets to a canvas. The implementation can be found
    in <b>skin.c</b>. The functions themselves use callbacks from a skin
    structure declared in <b>sgui_internal.h</b> with a default implementation
    in <b>skin_default.c</b>. The gui skin is hard coded. Somebody who is
    sufficiently bored might, for instance, implement a loadable skin by
    loading a Lua file and calling into that for drawing widgets.
</ul>

<h3 id="code">Coding style</h3>

As long as there is no indent file, here are a few guidelines:
<ul>
<li>Braces are always on the next line with the same indentation as
    the asociated control statement.
<li>Lines aren't longer than 80 characters.
<li>Space characters (4 of them) are used for indentation.
<li>There is no space between a function name and the opening paranthesis.
<li>There is no space between a control keyword and the opening paranthesis.
<li>There is no space between a closing paranthesis and a semicolon.
<li>There is a space between the first and last function argument and the
    asociated parantheses, unless line space needs to be conserved
<li>When wrapping a function call or declaration, the first argument in the
    next line is indented to the same column as the first argument.
<li>When wrapping expressions, the operator is always at the end of the line,
    never at the beginning of the new line.
</ul>
<br>
Also, when introducing new functions or structures:
<ul>
<li>Functions or structures delcared in publicly visible headers have to start
    with sgui_* prefix.
<li>Constatns have to start with SGUI_*
<li>Use C++ guards around publicly visible function declarations.
<li>Functions not declared in any headers have to be static.
<li>Publicly accessable headers have to start with sgui_*
<li>For every structure or union, there is a forward declaration in
    <b>sgui_predef.h</b>
<li>Every new header has to be included by <b>sgui.h</b>
</ul>

<hr>
<a href="thread.html">Previous</a>
<a href="index.html">Back to index</a>
<a href="hacking.oop.html">Next</a>

</body>
</html>

