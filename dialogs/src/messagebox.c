/*
 * messagebox.c
 * This file is part of sgui
 *
 * Copyright (C) 2012 - David Oberhollenzer
 *
 * Permission is hereby granted, free of charge, to any person obtaining a
 * copy of this software and associated documentation files (the "Software"),
 * to deal in the Software without restriction, including without limitation
 * the rights to use, copy, modify, merge, publish, distribute, sublicense,
 * and/or sell copies of the Software, and to permit persons to whom the
 * Software is furnished to do so, subject to the following conditions:
 * 
 * The above copyright notice and this permission notice shall be included in
 * all copies or substantial portions of the Software.
 * 
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING
 * FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER
 * DEALINGS IN THE SOFTWARE.
 */
#define SGUI_BUILDING_DLL
#include "sgui_messagebox.h"
#include "sgui_internal.h"
#include "sgui_dialog.h"
#include "sgui_button.h"
#include "sgui_widget.h"
#include "sgui_image.h"
#include "sgui_label.h"
#include "sgui_event.h"
#include "sgui_rect.h"

#include <stdlib.h>
#include <string.h>



#ifndef SGUI_NO_MESSAGEBOX
#define ICON_WIDTH  32
#define ICON_HEIGHT 32



static const unsigned char colormap[4*7] =
{
    0x00, 0x00, 0x00, 0x00,     /* fully transparent */
    0x00, 0x00, 0x00, 0xFF,     /* black */
    0xFF, 0xFF, 0xFF, 0x80,     /* semi transparent white */
    0xFF, 0xFF, 0xFF, 0xFF,     /* white */
    0x00, 0x00, 0xFF, 0xFF,     /* blue */
    0xFF, 0xFF, 0x00, 0xFF,     /* yellow */
    0xFF, 0x00, 0x00, 0xFF      /* red */
};

static const unsigned char info[ (ICON_WIDTH/2)*ICON_HEIGHT ] =
{
    000,000,000,000,000,001,011,011,011,010,000,000,000,000,000,000,
    000,000,000,000,011,013,033,033,033,031,011,000,000,000,000,000,
    000,000,000,011,033,033,033,033,033,033,033,011,000,000,000,000,
    000,000,001,033,033,033,033,033,033,033,033,033,010,000,000,000,
    000,000,013,033,033,033,034,044,043,033,033,033,031,000,000,000,
    000,001,033,033,033,033,044,044,044,033,033,033,033,010,000,000,
    000,013,033,033,033,033,044,044,044,033,033,033,033,031,000,000,
    001,033,033,033,033,033,034,044,043,033,033,033,033,033,010,000,
    001,033,033,033,033,033,033,033,033,033,033,033,033,033,012,000,
    013,033,033,033,033,033,033,033,033,033,033,033,033,033,031,020,
    013,033,033,033,033,034,044,044,044,033,033,033,033,033,031,020,
    013,033,033,033,033,033,034,044,044,033,033,033,033,033,031,022,
    013,033,033,033,033,033,034,044,044,033,033,033,033,033,031,022,
    013,033,033,033,033,033,034,044,044,033,033,033,033,033,031,022,
    013,033,033,033,033,033,034,044,044,033,033,033,033,033,031,022,
    013,033,033,033,033,033,034,044,044,033,033,033,033,033,031,022,
    001,033,033,033,033,033,034,044,044,033,033,033,033,033,012,022,
    001,033,033,033,033,033,034,044,044,033,033,033,033,033,012,022,
    000,013,033,033,033,033,034,044,044,033,033,033,033,031,022,020,
    000,001,033,033,033,034,044,044,044,044,033,033,033,012,022,020,
    000,000,013,033,033,033,033,033,033,033,033,033,031,022,022,000,
    000,000,001,033,033,033,033,033,033,033,033,033,012,022,020,000,
    000,000,000,011,033,033,033,033,033,033,033,011,022,022,000,000,
    000,000,000,002,011,013,033,033,033,031,011,022,022,020,000,000,
    000,000,000,000,022,021,011,033,033,012,022,022,022,000,000,000,
    000,000,000,000,000,022,022,013,033,012,022,022,000,000,000,000,
    000,000,000,000,000,000,002,013,033,012,020,000,000,000,000,000,
    000,000,000,000,000,000,000,001,033,012,020,000,000,000,000,000,
    000,000,000,000,000,000,000,000,013,012,020,000,000,000,000,000,
    000,000,000,000,000,000,000,000,001,012,020,000,000,000,000,000,
    000,000,000,000,000,000,000,000,000,022,020,000,000,000,000,000,
    000,000,000,000,000,000,000,000,000,002,020,000,000,000,000,000
};

static const unsigned char warning[ (ICON_WIDTH/2)*ICON_HEIGHT ]=
{
    000,000,000,000,000,000,001,011,000,000,000,000,000,000,000,000,
    000,000,000,000,000,000,015,055,010,000,000,000,000,000,000,000,
    000,000,000,000,000,001,055,055,051,020,000,000,000,000,000,000,
    000,000,000,000,000,001,055,055,051,022,000,000,000,000,000,000,
    000,000,000,000,000,015,055,055,055,012,020,000,000,000,000,000,
    000,000,000,000,000,015,055,055,055,012,020,000,000,000,000,000,
    000,000,000,000,001,055,055,055,055,051,022,000,000,000,000,000,
    000,000,000,000,001,055,055,055,055,051,022,000,000,000,000,000,
    000,000,000,000,015,055,055,055,055,055,012,020,000,000,000,000,
    000,000,000,000,015,055,051,011,055,055,012,020,000,000,000,000,
    000,000,000,001,055,055,011,011,015,055,051,022,000,000,000,000,
    000,000,000,001,055,055,011,011,015,055,051,022,000,000,000,000,
    000,000,000,015,055,055,011,011,015,055,055,012,020,000,000,000,
    000,000,000,015,055,055,011,011,015,055,055,012,020,000,000,000,
    000,000,001,055,055,055,011,011,015,055,055,051,022,000,000,000,
    000,000,001,055,055,055,011,011,015,055,055,051,022,000,000,000,
    000,000,015,055,055,055,051,011,055,055,055,055,012,020,000,000,
    000,000,015,055,055,055,051,011,055,055,055,055,012,020,000,000,
    000,001,055,055,055,055,051,011,055,055,055,055,051,022,000,000,
    000,001,055,055,055,055,055,015,055,055,055,055,051,022,000,000,
    000,015,055,055,055,055,055,015,055,055,055,055,055,012,020,000,
    000,015,055,055,055,055,055,055,055,055,055,055,055,012,020,000,
    001,055,055,055,055,055,055,011,055,055,055,055,055,051,022,000,
    001,055,055,055,055,055,051,011,015,055,055,055,055,051,022,000,
    015,055,055,055,055,055,051,011,015,055,055,055,055,055,012,020,
    015,055,055,055,055,055,055,011,055,055,055,055,055,055,012,020,
    015,055,055,055,055,055,055,055,055,055,055,055,055,055,012,022,
    015,055,055,055,055,055,055,055,055,055,055,055,055,055,012,022,
    001,055,055,055,055,055,055,055,055,055,055,055,055,051,022,022,
    000,011,011,011,011,011,011,011,011,011,011,011,011,012,022,022,
    000,000,022,022,022,022,022,022,022,022,022,022,022,022,022,020,
    000,000,002,022,022,022,022,022,022,022,022,022,022,022,022,000
};

static const unsigned char critical[ (ICON_WIDTH/2)*ICON_HEIGHT ]=
{
    000,000,000,000,000,001,011,011,011,010,000,000,000,000,000,000,
    000,000,000,000,001,016,066,066,066,061,010,000,000,000,000,000,
    000,000,000,001,016,066,066,066,066,066,061,010,000,000,000,000,
    000,000,000,016,066,066,066,066,066,066,066,061,000,000,000,000,
    000,000,001,066,066,066,066,066,066,066,066,066,012,000,000,000,
    000,000,016,066,066,066,066,066,066,066,066,066,061,020,000,000,
    000,001,066,066,066,066,066,066,066,066,066,066,066,012,000,000,
    000,016,066,066,063,066,066,066,066,066,036,066,066,061,020,000,
    000,016,066,066,033,036,066,066,066,063,033,066,066,061,020,000,
    001,066,066,063,033,033,066,066,066,033,033,036,066,066,012,000,
    001,066,066,066,033,033,036,066,063,033,033,066,066,066,012,000,
    016,066,066,066,063,033,033,066,033,033,036,066,066,066,061,020,
    016,066,066,066,066,033,033,033,033,033,066,066,066,066,061,020,
    016,066,066,066,066,063,033,033,033,036,066,066,066,066,061,022,
    016,066,066,066,066,066,033,033,033,066,066,066,066,066,061,022,
    016,066,066,066,066,066,033,033,033,066,066,066,066,066,061,022,
    016,066,066,066,066,063,033,033,033,036,066,066,066,066,061,022,
    016,066,066,066,066,033,033,033,033,033,066,066,066,066,061,022,
    016,066,066,066,063,033,033,066,033,033,036,066,066,066,061,022,
    001,066,066,066,033,033,036,066,063,033,033,066,066,066,012,020,
    001,066,066,063,033,033,066,066,066,033,033,036,066,066,012,020,
    000,016,066,066,033,036,066,066,066,063,033,066,066,061,022,020,
    000,016,066,066,063,066,066,066,066,066,036,066,066,061,022,000,
    000,001,066,066,066,066,066,066,066,066,066,066,066,012,022,000,
    000,000,016,066,066,066,066,066,066,066,066,066,061,022,020,000,
    000,000,021,066,066,066,066,066,066,066,066,066,012,022,000,000,
    000,000,002,016,066,066,066,066,066,066,066,061,022,020,000,000,
    000,000,000,021,016,066,066,066,066,066,066,012,022,000,000,000,
    000,000,000,002,021,016,066,066,066,061,012,022,020,000,000,000,
    000,000,000,000,002,021,011,011,011,012,022,022,000,000,000,000,
    000,000,000,000,000,002,022,022,022,022,022,000,000,000,000,000,
    000,000,000,000,000,000,002,022,022,022,000,000,000,000,000,000
};

static const unsigned char question[ (ICON_WIDTH/2)*ICON_HEIGHT ] =
{
    000,000,000,000,000,001,011,011,011,010,000,000,000,000,000,000,
    000,000,000,000,011,013,033,033,033,031,011,000,000,000,000,000,
    000,000,000,011,033,033,033,033,033,033,033,011,000,000,000,000,
    000,000,001,033,033,033,033,033,033,033,033,033,010,000,000,000,
    000,000,013,033,033,033,033,033,033,033,033,033,031,000,000,000,
    000,001,033,033,033,033,044,044,044,033,033,033,033,010,000,000,
    000,013,033,033,033,034,033,034,044,043,033,033,033,031,000,000,
    001,033,033,033,033,044,033,033,044,044,033,033,033,033,010,000,
    001,033,033,033,033,044,044,033,044,044,033,033,033,033,012,000,
    013,033,033,033,033,044,044,033,044,044,033,033,033,033,031,020,
    013,033,033,033,033,034,043,034,044,043,033,033,033,033,031,020,
    013,033,033,033,033,033,033,044,044,033,033,033,033,033,031,022,
    013,033,033,033,033,033,033,044,043,033,033,033,033,033,031,022,
    013,033,033,033,033,033,033,044,033,033,033,033,033,033,031,022,
    013,033,033,033,033,033,033,044,033,033,033,033,033,033,031,022,
    013,033,033,033,033,033,033,033,033,033,033,033,033,033,031,022,
    001,033,033,033,033,033,033,044,033,033,033,033,033,033,012,022,
    001,033,033,033,033,033,034,044,043,033,033,033,033,033,012,022,
    000,013,033,033,033,033,034,044,043,033,033,033,033,031,022,020,
    000,001,033,033,033,033,033,044,033,033,033,033,033,012,022,020,
    000,000,013,033,033,033,033,033,033,033,033,033,031,022,022,000,
    000,000,001,033,033,033,033,033,033,033,033,033,012,022,020,000,
    000,000,000,011,033,033,033,033,033,033,033,011,022,022,000,000,
    000,000,000,002,011,013,033,033,033,031,011,022,022,020,000,000,
    000,000,000,000,022,021,011,033,033,012,022,022,022,000,000,000,
    000,000,000,000,000,022,022,013,033,012,022,022,000,000,000,000,
    000,000,000,000,000,000,002,013,033,012,020,000,000,000,000,000,
    000,000,000,000,000,000,000,001,033,012,020,000,000,000,000,000,
    000,000,000,000,000,000,000,000,013,012,020,000,000,000,000,000,
    000,000,000,000,000,000,000,000,001,012,020,000,000,000,000,000,
    000,000,000,000,000,000,000,000,000,022,020,000,000,000,000,000,
    000,000,000,000,000,000,000,000,000,002,020,000,000,000,000,000
};




typedef struct
{
    sgui_dialog super;

    sgui_widget* text;
    sgui_widget* icon;
}
sgui_message_box;



static void message_box_button_pressed( sgui_dialog* super, int button )
{
    sgui_message_box* this = (sgui_message_box*)super;
    struct sgui_event ev;

    ev.src.other = this;

    switch( button )
    {
    case 0:  ev.type = SGUI_MESSAGE_BOX_BUTTON1_EVENT; break;
    case 1:  ev.type = SGUI_MESSAGE_BOX_BUTTON2_EVENT; break;
    case 2:  ev.type = SGUI_MESSAGE_BOX_BUTTON3_EVENT; break;
    default: ev.type = SGUI_DIALOG_REJECTED;           break;
    }

    sgui_window_set_visible( super->window, SGUI_INVISIBLE );
    sgui_event_post( &ev );
}

static void sgui_message_box_destroy( sgui_dialog* super )
{
    sgui_message_box* this = (sgui_message_box*)super;
    sgui_widget_destroy( this->text );
    sgui_widget_destroy( this->icon );
    free( this );
}

/****************************************************************************/

sgui_dialog* sgui_message_box_create( int icon, const char* caption,
                                      const char* text,
                                      const char* button1,
                                      const char* button2,
                                      const char* button3 )
{
    unsigned int text_w, text_h, w, h, x, y;
    unsigned char icon_image[ICON_WIDTH*ICON_HEIGHT*4], c;
    const unsigned char* iptr;
    sgui_message_box* this;
    unsigned char* dptr;
    sgui_dialog* super;
    sgui_rect r;

    this = malloc( sizeof(sgui_message_box) );
    super = (sgui_dialog*)this;

    if( !this )
        return NULL;

    memset( this, 0, sizeof(sgui_message_box) );

    /* determine element sizes */
    sgui_skin_get_text_extents( text, &r );
    text_w = SGUI_RECT_WIDTH(r);
    text_h = SGUI_RECT_HEIGHT(r);

    w = 10+ICON_WIDTH+10+text_w+10;
    h = 10+MAX(text_h,ICON_HEIGHT)+5;

    /* create the message box window */
    super->window = sgui_window_create( NULL, w, h, SGUI_FIXED_SIZE );

    if( !super->window )
        goto fail;

    sgui_window_set_title( super->window, caption );

    super->destroy = sgui_message_box_destroy;
    super->handle_button = message_box_button_pressed;

    /* decode the icon image */
         if( icon==SGUI_MB_WARNING  ) iptr = warning;
    else if( icon==SGUI_MB_CRITICAL ) iptr = critical;
    else if( icon==SGUI_MB_QUESTION ) iptr = question;
    else                              iptr = info;

    for( dptr=icon_image, y=0; y<ICON_HEIGHT; ++y )
    {
        for( x=0; x<ICON_WIDTH; x+=2, ++iptr )
        {
            c = ((*iptr & 070)>>3)*4;
            *(dptr++) = colormap[ c   ];
            *(dptr++) = colormap[ c+1 ];
            *(dptr++) = colormap[ c+2 ];
            *(dptr++) = colormap[ c+3 ];

            c = (*iptr & 007)*4;
            *(dptr++) = colormap[ c   ];
            *(dptr++) = colormap[ c+1 ];
            *(dptr++) = colormap[ c+2 ];
            *(dptr++) = colormap[ c+3 ];
        }
    }

    /* create widgets */
    y = ICON_HEIGHT>text_h ? (ICON_HEIGHT-text_h)/2 : 0;
    this->text = sgui_label_create( 10+ICON_WIDTH+10, y+10, text );

    if( !this->text )
        goto fail;

    y = ICON_HEIGHT>text_h ? 0 : (text_h-ICON_HEIGHT)/2;
    this->icon = sgui_image_create( 10, 10+y, ICON_WIDTH, ICON_HEIGHT,
                                    icon_image, SGUI_RGBA8, 1, 0 );

    if( !this->icon )
        goto fail;

    if( !sgui_dialog_init( super, button1, button2, button3, SGUI_CENTER ) )
        goto fail;

    sgui_window_add_widget( super->window, this->text );
    sgui_window_add_widget( super->window, this->icon );
    return (sgui_dialog*)this;
fail:
    sgui_dialog_destroy( super );
    return NULL;
}
#elif defined(SGUI_NOP_IMPLEMENTATIONS)
sgui_dialog* sgui_message_box_create( int icon, const char* caption,
                                      const char* text, const char* button1,
                                      const char* button2,
                                      const char* button3 )
{
    (void)icon; (void)caption; (void)text;
    (void)button1; (void)button2; (void)button3;
    return NULL;
}
#endif /* !SGUI_NO_MESSAGEBOX */

